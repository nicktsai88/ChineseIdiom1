<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆèªå¤§æŒ‘æˆ° | æ°´å¢¨æ›¸é™¢ (AIç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- ğŸ¨ è¦–è¦ºæ¨£å¼ (ç¶­æŒæ°´å¢¨é¢¨æ ¼) --- */
        :root {
            --primary-color: #2C3E50; 
            --secondary-color: #5D7A64; 
            --bg-color: #F7F7F2; 
            --text-color: #1a1a1a; 
            --accent-color: #922B21; 
            --correct-color: #2E8B57; 
            --wrong-color: #C0392B; 
            --ai-btn-color: #6C3483;
        }

        body { 
            font-family: 'Noto Serif TC', "Microsoft JhengHei", serif; 
            max-width: 900px; margin: 0 auto; padding: 20px; 
            background-color: var(--bg-color); color: var(--text-color);
            background-image: radial-gradient(#D0D3D4 1px, transparent 1px);
            background-size: 20px 20px; min-height: 100vh;
        }

        h1 { font-family: 'Zhi Mang Xing', cursive; font-size: 3.5em; color: var(--primary-color); text-align: center; margin-top: 0; text-shadow: 3px 3px 0px rgba(0,0,0,0.1); }
        .quiz-container { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 8px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); border: 4px solid var(--primary-color); position: relative; overflow: hidden; min-height: 600px; }
        .quiz-container::before { content: " "; position: absolute; top: 10px; left: 10px; width: 20px; height: 20px; border-top: 4px solid var(--primary-color); border-left: 4px solid var(--primary-color); }
        .quiz-container::after { content: " "; position: absolute; bottom: 10px; right: 10px; width: 20px; height: 20px; border-bottom: 4px solid var(--primary-color); border-right: 4px solid var(--primary-color); }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .btn { background-color: var(--primary-color); color: #FFF; border: none; padding: 10px 24px; font-size: 1.1em; border-radius: 4px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 0 #1a252f; font-family: 'Noto Serif TC', serif; font-weight: bold; margin: 5px; display: inline-block; }
        .btn:hover { transform: translateY(-2px); background-color: #34495E; }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-purple { background-color: var(--ai-btn-color); box-shadow: 0 4px 0 #4A235A; color: white; }
        .btn-green { background-color: var(--secondary-color); box-shadow: 0 4px 0 #3E5242; }
        .btn-gray { background-color: #95A5A6; box-shadow: 0 4px 0 #7F8C8D; }
        .btn:disabled { background-color: #BDC3C7; cursor: not-allowed; box-shadow: none; transform: none; }

        input[type="text"], input[type="password"] {
            padding: 12px; font-size: 1.1em; 
            border: 2px solid var(--primary-color); border-top: none; border-right: none; border-left: none;
            background-color: transparent; margin: 10px; width: 70%; color: var(--text-color);
            outline: none; text-align: center;
        }

        /* å­¸ç¿’å¡ç‰‡æ¨£å¼ */
        .learning-card {
            background: #FFF; border: 1px solid #D5D8DC; border-radius: 8px;
            padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            position: relative; transition: 0.3s; border-left: 5px solid var(--secondary-color);
        }
        .idiom-title { font-size: 2em; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; font-family: 'Zhi Mang Xing', cursive; }
        .idiom-info { font-size: 1.1em; line-height: 1.6; color: #555; margin: 8px 0; }
        
        /* AI åœ–ç‰‡å€åŸŸ */
        .ai-image-container {
            width: 100%; min-height: 250px; background: #F8F9F9; border-radius: 6px;
            margin-top: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden; position: relative; border: 2px dashed #BDC3C7; padding: 10px;
        }
        .generated-img { width: 100%; height: auto; max-height: 300px; object-fit: contain; border-radius: 4px; animation: fadeIn 1s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .ai-desc { font-size: 0.9em; color: #5D6D7E; margin-top: 10px; font-style: italic; background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 15px; }
        
        /* Loading å‹•ç•« */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--ai-btn-color); border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ¸¬é©—é¸é … */
        .option-btn { width: 100%; padding: 15px; margin: 10px 0; text-align: left; background: white; border: 1px solid #BDC3C7; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 1.2em; }
        .correct { background-color: #D5F5E3 !important; border-color: var(--correct-color) !important; color: #145A32; }
        .wrong { background-color: #FADBD8 !important; border-color: var(--wrong-color) !important; color: #7B241C; }
    </style>
</head>
<body>
    <div class="quiz-container">
        
        <div id="welcome-screen" class="fade-in">
            <h1>æˆèªå¤§æŒ‘æˆ°</h1>
            <p style="text-align: center; color: #555;">æ›¸é™¢ä¿®ç…‰ï¼Œå§‹æ–¼è¶³ä¸‹ã€‚<br><small>èåˆ AI åœ–åƒç”ŸæˆæŠ€è¡“</small></p>
            
            <div style="text-align:center; margin: 20px 0;">
                <input type="text" id="username" placeholder="è«‹è¼¸å…¥é–£ä¸‹å¤§å" value="å¼µç„¡å¿Œ"><br>
                <input type="password" id="api-key-input" placeholder="è«‹è²¼ä¸Š Google AI API Key" style="font-size: 0.9em; width: 80%;">
                <div style="font-size: 0.8em; color: #999; margin-top: 5px;">* Key åƒ…ç”¨æ–¼æœ¬æ©Ÿè«‹æ±‚ï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨</div>
            </div>

            <div style="text-align:center;">
                <button class="btn" onclick="loginAndStart()">ğŸšª é€²å…¥æ›¸é™¢</button>
            </div>
        </div>

        <div id="level-screen" style="display: none; text-align: center;" class="fade-in">
            <h2>ğŸ—ºï¸ ä¿®ç…‰åœ°åœ–</h2>
            <p>æ­¡è¿ï¼Œ<span id="display-name" style="color:var(--primary-color); font-weight:bold;"></span></p>
            
            <div id="level-list" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 30px 0;">
                </div>
            <button class="btn btn-gray" onclick="location.reload()">é€€å‡º</button>
        </div>

        <div id="learning-screen" style="display: none;" class="fade-in">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                <div>
                    <h3 style="margin:0; display:inline;">ğŸ“– è—ç¶“é–£</h3>
                    <span style="font-size:0.9em; color:#777; margin-left:10px;">é€²åº¦ï¼š<span id="learn-progress">1</span> / <span id="learn-total">15</span></span>
                </div>
                <button id="btn-batch-gen" class="btn btn-purple btn-sm" onclick="generateAllImages()" style="font-size: 0.9em; padding: 5px 15px;">
                    ğŸª„ ä¸€éµç”Ÿæˆæœ¬å› 15 å¼µåœ–è§£
                </button>
            </div>

            <div id="learning-card-container">
                </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <button class="btn btn-gray" onclick="prevLearnCard()" id="btn-prev-card" disabled>â¬…ï¸ ä¸Šä¸€å€‹</button>
                <button class="btn btn-green" onclick="nextLearnCard()" id="btn-next-card">ä¸‹ä¸€å€‹ â¡ï¸</button>
                <button class="btn btn-red" onclick="finishLearning()" id="btn-start-quiz" style="display:none;">ğŸ“ é–‹å§‹æ¸¬é©—ï¼</button>
            </div>
            
            <div style="margin-top: 10px; text-align: center;">
                 <button class="btn btn-gray btn-sm" onclick="backToMap()">ğŸ  è¿”å›åœ°åœ–</button>
            </div>
        </div>

        <div id="quiz-screen" style="display: none;" class="fade-in">
            <h3>ğŸ“ éš¨å ‚è€ƒ</h3>
            <div style="width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-bottom: 15px;">
                <div id="quiz-progress-bar" style="width: 0%; background: var(--secondary-color); height: 100%; border-radius: 5px; transition: 0.3s;"></div>
            </div>
            <div id="question-container">
                <p id="question-text" style="font-size: 1.4em; font-weight: bold; color: #333; margin-bottom: 20px;">é¡Œç›®è¼‰å…¥ä¸­...</p>
                <div id="options-list"></div>
            </div>
            <div id="feedback-area" style="display: none; margin-top: 15px; padding: 15px; background: #F9E79F; border-radius: 5px; color: #7D6608;"></div>
            <button id="quiz-next-btn" class="btn" style="display: none; width: 100%; margin-top: 20px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ</button>
        </div>

        <div id="result-screen" style="display: none; text-align: center;" class="fade-in">
            <h2 style="color: var(--primary-color);">ğŸ‰ ä¿®ç…‰å®Œæˆï¼</h2>
            <p style="font-size: 3em; color: var(--accent-color); font-weight: bold;"><span id="final-score">0</span> åˆ†</p>
            <div id="result-comment"></div>
            <br>
            <button class="btn" onclick="backToMap()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
        </div>

    </div>

    <script>
        // --- 1. è³‡æ–™è™•ç† (åŒ…å«æ‚¨æä¾›çš„éƒ¨åˆ†è³‡æ–™ç¯„ä¾‹) ---
        // ç‚ºäº†å®Œæ•´æ€§ï¼Œé€™è£¡éœ€è¦æ‚¨ä¹‹å‰å°‡æ–‡å­—æª”è½‰æ›å¾Œçš„å®Œæ•´ JSONã€‚
        // ç‚ºæ¼”ç¤ºåŠŸèƒ½ï¼Œé€™è£¡é å¡«ç¬¬ä¸€é¡è³‡æ–™ã€‚
        const FULL_DATA = [
            { "id": "1", "idiom": "ç´„æ³•ä¸‰ç« ", "meaning": "äº‹å‰ç´„å®šå¥½è¦å‰‡ã€‚", "example": "è€å¸«é–‹å­¸ç¬¬ä¸€å¤©å°±å’Œå¤§å®¶ç´„æ³•ä¸‰ç« ï¼Œé²åˆ°ä¸‰æ¬¡å°±è¦é€²è¡Œæ„›æ ¡æœå‹™ã€‚", "quiz": { "question": "ç‚ºäº†è®“ç­ç´šç®¡ç†æ›´æœ‰ç§©åºï¼Œå°å¸«åœ¨é–‹å­¸ç¬¬ä¸€å¤©å°±èˆ‡åŒå­¸______ï¼Œå®šä¸‹å¹¾æ¢ç°¡å–®æ˜ç¢ºçš„è¦å‰‡ã€‚", "options": ["(A) é€é™æ³•å¤–", "(B) ç´„æ³•ä¸‰ç« ", "(C) è²ªè´“æ‰æ³•", "(D) ç¹©ä¹‹ä»¥æ³•"], "answer": "(B)" } },
            { "id": "2", "idiom": "è²ªè´“æ‰æ³•", "meaning": "è²ªæ±™å—è³„ï¼Œé•æ³•äº‚ç´€ã€‚", "example": "é‚£ä½å®˜å“¡å› è²ªè´“æ‰æ³•è¢«æª¢èˆ‰ï¼Œæœ€çµ‚é­åˆ°é©è·æŸ¥è¾¦ã€‚", "quiz": { "question": "é‚£ä½å®˜å“¡å› æ¶‰å«Œ______ï¼Œæ”¶å—å·¨é¡è³„è³‚ï¼Œæœ€çµ‚é­åˆ°æª¢æ–¹èµ·è¨´ã€‚", "options": ["(A) å¥‰å…¬å®ˆæ³•", "(B) è²ªè´“æ‰æ³•", "(C) æ˜å¯Ÿç§‹æ¯«", "(D) å‰›æ­£ä¸é˜¿"], "answer": "(B)" } },
            { "id": "3", "idiom": "ç¹©ä¹‹ä»¥æ³•", "meaning": "ä»¥æ³•å¾‹åˆ¶è£ç½ªçŠ¯ã€‚", "example": "è­¦æ–¹èª“è¨€è¦å°‡é€™èµ·æ¶åŠ«æ¡ˆçš„å«ŒçŠ¯é€®æ•æ­¸æ¡ˆï¼Œç¹©ä¹‹ä»¥æ³•ã€‚", "quiz": { "question": "è­¦æ–¹èª“è¨€è¦å°‡é€™èµ·éœ‡é©šç¤¾æœƒçš„æ¶åŠ«æ¡ˆå«ŒçŠ¯é€®æ•æ­¸æ¡ˆï¼Œä¸¦______ã€‚", "options": ["(A) ç¹©ä¹‹ä»¥æ³•", "(B) é€é™æ³•å¤–", "(C) ä½œæ³•è‡ªæ–ƒ", "(D) çŸ¥æ³•çŠ¯æ³•"], "answer": "(A)" } },
            { "id": "4", "idiom": "ç„¡æ³•ç„¡å¤©", "meaning": "å½¢å®¹äººæ¥µç‚ºæ”¾è‚†ï¼Œæ²’æœ‰æ³•ç´€ã€‚", "example": "é€™ç¾¤é£†è»Šæ—åœ¨å¤§è¡—ä¸Šæ©«è¡ç›´æ’ï¼Œç°¡ç›´æ˜¯ç„¡æ³•ç„¡å¤©ã€‚", "quiz": { "question": "é€™ç¾¤é£†è»Šæ—åœ¨å¤§è¡—ä¸Šæ©«è¡ç›´æ’ï¼Œç„¡è¦–äº¤é€šè™ŸèªŒï¼Œç°¡ç›´æ˜¯______ã€‚", "options": ["(A) å¥‰å…¬å®ˆæ³•", "(B) éµé¢ç„¡ç§", "(C) ç„¡æ³•ç„¡å¤©", "(D) è¬¹è¨€æ…è¡Œ"], "answer": "(C)" } },
            { "id": "5", "idiom": "å¥‰å…¬å®ˆæ³•", "meaning": "è¬¹å®ˆå…¬å‹™å“¡çš„æœ¬åˆ†ï¼Œéµå®ˆæ³•ä»¤ã€‚", "example": "ä»–ä¸€ç”Ÿå¥‰å…¬å®ˆæ³•ï¼Œå¾æœªåšéä»»ä½•è™§å¿ƒäº‹ï¼Œæ·±å—é„°é‡Œæ•¬é‡ã€‚", "quiz": { "question": "æ—å…ˆç”Ÿä¸€ç”Ÿ______ï¼Œè¬¹å®ˆå…¬å‹™å“¡çš„æœ¬åˆ†ï¼Œå¾æœªåˆ©ç”¨è·æ¬Šè¬€å–ç§åˆ©ã€‚", "options": ["(A) è²ªè´“æ‰æ³•", "(B) çµé»¨ç‡Ÿç§", "(C) å¥‰å…¬å®ˆæ³•", "(D) ç©æ³•å¼„æ¬Š"], "answer": "(C)" } }
        ];
        
        // æ¨¡æ“¬è£œå……è³‡æ–™è‡³ 15 é¡Œä»¥æ¸¬è©¦æ‰¹é‡ç”Ÿæˆ
        for(let i=6; i<=15; i++) {
            FULL_DATA.push({
                "id": i.toString(), "idiom": "æˆèªæ¸¬è©¦" + i, "meaning": "é€™æ˜¯ç¬¬ "+i+" å€‹æ¸¬è©¦æˆèªã€‚", "example": "æ¸¬è©¦ä¾‹å¥ã€‚", 
                "quiz": { "question": "æ¸¬è©¦é¡Œç›®?", "options": ["(A) A", "(B) B", "(C) C", "(D) D"], "answer": "(A)" }
            });
        }

        // --- 2. è®Šæ•¸èˆ‡ç‹€æ…‹ ---
        let GOOGLE_API_KEY = "";
        let currentLevelData = [];
        let currentCardIndex = 0;
        let currentQuizIndex = 0;
        let score = 0;
        let aiImageCache = {}; // ç·©å­˜å·²ç”Ÿæˆçš„åœ–ç‰‡ {id: {url: "...", desc: "..."}}
        let isGeneratingBatch = false; // æ˜¯å¦æ­£åœ¨æ‰¹é‡ç”Ÿæˆ

        // --- 3. æ ¸å¿ƒ API é‚è¼¯ (ç§»æ¤è‡ªæ‚¨çš„æˆèªå¤§å¸« App) ---
        
        // ç¶²è·¯è«‹æ±‚é‡è©¦å‡½å¼
        const fetchWithRetry = async (url, options, retries = 3, backoff = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok && retries > 0) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries === 0) throw error;
                await new Promise(r => setTimeout(r, backoff));
                return fetchWithRetry(url, options, retries - 1, backoff * 2);
            }
        };

        // æ­¥é©Ÿä¸€ï¼šç”Ÿæˆåœ–ç‰‡æç¤ºè© (Text Model)
        const generateImagePrompt = async (idiom, definition) => {
            const systemPrompt = `
                You are an AI visual assistant for a Chinese idiom learning app.
                Your task is to create a visual concept for the idiom: "${idiom}" (Definition: ${definition}).
                Goal: Create a metaphorical or literal scene that helps students understand the meaning.
                CRITICAL REQUIREMENT: The image must NOT contain any text, Chinese characters, letters, or typography. It must be purely visual.
                Return ONLY a JSON object with these two fields:
                1. "chineseDescription": A short, educational description in Traditional Chinese (ç¹é«”ä¸­æ–‡) explaining the visual metaphor. Max 40 chars.
                2. "englishPrompt": A highly detailed image generation prompt. Style: "Traditional Chinese Ink wash painting style, artistic, watercolor, simple, minimalistic, educational, no text".
            `;
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨äº†æ‚¨èˆŠæª”æ¡ˆä¸­çš„ gemini-2.5-flash-previewï¼Œå¦‚æœå¤±æ•ˆå¯æ”¹ç”¨ gemini-1.5-flash
            try {
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GOOGLE_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    }
                );
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return text ? JSON.parse(text) : null;
            } catch (e) {
                console.error("Prompt generation failed", e);
                return null;
            }
        };

        // æ­¥é©ŸäºŒï¼šç”Ÿæˆåœ–ç‰‡ (Image Model)
        const generateImage = async (prompt) => {
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨äº†æ‚¨èˆŠæª”æ¡ˆä¸­çš„ imagen-4.0
            try {
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${GOOGLE_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instances: [{ prompt: prompt }],
                            parameters: { sampleCount: 1 }
                        })
                    }
                );
                const data = await response.json();
                if (data.predictions && data.predictions[0]) {
                    return `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                }
                return null;
            } catch (e) {
                console.error("Image generation failed", e);
                return null;
            }
        };

        // --- 4. æ‡‰ç”¨ç¨‹å¼åŠŸèƒ½ ---

        function loginAndStart() {
            const key = document.getElementById('api-key-input').value.trim();
            const name = document.getElementById('username').value || "å­¸å­";
            
            if (!key) {
                alert("è«‹è¼¸å…¥ API Key ä»¥å•Ÿç”¨ AI ç¹ªåœ–åŠŸèƒ½ï¼");
                return;
            }
            GOOGLE_API_KEY = key;
            document.getElementById('display-name').innerText = name;
            
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('level-screen').style.display = 'block';
            renderLevels();
        }

        function renderLevels() {
            const container = document.getElementById('level-list');
            container.innerHTML = "";
            const totalLevels = Math.ceil(FULL_DATA.length / 15); // æ¯é—œ 15 é¡Œ
            
            for(let i=1; i<=totalLevels; i++) {
                let btn = document.createElement('button');
                btn.className = "btn";
                btn.innerHTML = `ç¬¬ ${i} å› <br><small>äº‹ç†ç¯‡</small>`;
                btn.onclick = () => startLevel(i);
                container.appendChild(btn);
            }
        }

        function startLevel(levelNum) {
            const start = (levelNum - 1) * 15;
            const end = start + 15;
            currentLevelData = FULL_DATA.slice(start, end);

            document.getElementById('level-screen').style.display = 'none';
            document.getElementById('learning-screen').style.display = 'block';
            document.getElementById('learn-total').innerText = currentLevelData.length;
            
            currentCardIndex = 0;
            renderLearningCard();
        }

        // æ¸²æŸ“å­¸ç¿’å¡ç‰‡
        function renderLearningCard() {
            const data = currentLevelData[currentCardIndex];
            const container = document.getElementById('learning-card-container');
            const cached = aiImageCache[data.id];

            // æ§‹å»º AI å€åŸŸå…§å®¹
            let aiContent = '';
            if (cached) {
                // å·²æœ‰åœ–ç‰‡
                aiContent = `
                    <img src="${cached.url}" class="generated-img">
                    <div class="ai-desc">ğŸ’¡ ${cached.desc}</div>
                `;
            } else {
                // ç„¡åœ–ç‰‡
                aiContent = `
                    <div id="ai-placeholder-${data.id}" style="text-align:center; color:#999;">
                        <div style="font-size:3em; opacity:0.3;">ğŸ–¼ï¸</div>
                        <p>é»æ“Šä¸Šæ–¹ã€Œä¸€éµç”Ÿæˆã€<br>æˆ–å–®ç¨é»æ“Šä¸‹æ–¹æŒ‰éˆ•</p>
                        <button class="btn btn-purple btn-sm" onclick="generateSingleImage('${data.id}')" ${isGeneratingBatch ? 'disabled' : ''}>
                             âœ¨ ç”Ÿæˆæ­¤åœ–
                        </button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="learning-card">
                    <div class="idiom-title">${data.idiom}</div>
                    <div class="idiom-info"><strong>ã€é‡‹ç¾©ã€‘</strong>${data.meaning}</div>
                    <div class="idiom-info"><strong>ã€ä¾‹å¥ã€‘</strong>${data.example}</div>
                    
                    <div class="ai-image-container" id="ai-container-${data.id}">
                        ${aiContent}
                    </div>
                </div>
            `;

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('learn-progress').innerText = currentCardIndex + 1;
            document.getElementById('btn-prev-card').disabled = (currentCardIndex === 0);
            
            if (currentCardIndex === currentLevelData.length - 1) {
                document.getElementById('btn-next-card').style.display = 'none';
                document.getElementById('btn-start-quiz').style.display = 'inline-block';
            } else {
                document.getElementById('btn-next-card').style.display = 'inline-block';
                document.getElementById('btn-start-quiz').style.display = 'none';
            }
        }

        // --- æ‰¹é‡ç”Ÿæˆæ ¸å¿ƒé‚è¼¯ ---
        async function generateAllImages() {
            if (isGeneratingBatch) return;
            if (!confirm(`å³å°‡ä¾åºç‚ºæœ¬å› ${currentLevelData.length} å€‹æˆèªç”Ÿæˆåœ–ç‰‡ï¼Œé€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“ã€‚ç¢ºå®šé–‹å§‹å—ï¼Ÿ`)) return;

            isGeneratingBatch = true;
            document.getElementById('btn-batch-gen').disabled = true;
            document.getElementById('btn-batch-gen').innerText = "â³ AI ç•«å¸«ä½œç•«ä¸­...";

            // æ‰¾å‡ºæ‰€æœ‰é‚„æ²’ç”Ÿæˆåœ–ç‰‡çš„é …ç›®
            const itemsToGen = currentLevelData.filter(item => !aiImageCache[item.id]);

            for (const item of itemsToGen) {
                // å¦‚æœç•¶å‰æ­£åœ¨çœ‹é€™å¼µå¡ç‰‡ï¼Œé¡¯ç¤º Loading
                const container = document.getElementById(`ai-container-${item.id}`);
                if (container) {
                    container.innerHTML = `<div class="loader"></div><div style="color:#6C3483;">AI æ­£åœ¨æ§‹æ€ã€Œ${item.idiom}ã€...</div>`;
                }

                try {
                    // 1. ç”Ÿæˆ Prompt
                    const promptData = await generateImagePrompt(item.idiom, item.meaning);
                    if (!promptData) throw new Error("Prompt generation failed");

                    if (container) container.innerHTML = `<div class="loader"></div><div style="color:#6C3483;">æ­£åœ¨ç¹ªè£½æ°´å¢¨æ„å¢ƒ...</div>`;

                    // 2. ç”Ÿæˆ Image
                    const imgBase64 = await generateImage(promptData.englishPrompt);
                    
                    if (imgBase64) {
                        // å­˜å…¥ç·©å­˜
                        aiImageCache[item.id] = {
                            url: imgBase64,
                            desc: promptData.chineseDescription
                        };
                        // å¦‚æœç•¶å‰æ­£å¥½åœ¨é¡¯ç¤ºé€™å¼µï¼Œç«‹åˆ»æ›´æ–° UI
                        if (currentLevelData[currentCardIndex].id === item.id) {
                            renderLearningCard();
                        }
                    }

                } catch (e) {
                    console.error(`ç”Ÿæˆå¤±æ•—: ${item.idiom}`, e);
                    if (container) container.innerHTML = `<div style="color:red;">ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
                }
                
                // ç¨å¾®å»¶é²é¿å…è§¸ç™¼ Rate Limit
                await new Promise(r => setTimeout(r, 1000));
            }

            isGeneratingBatch = false;
            document.getElementById('btn-batch-gen').disabled = false;
            document.getElementById('btn-batch-gen').innerText = "âœ… ç”Ÿæˆå®Œç•¢";
        }

        // å–®å¼µç”Ÿæˆ (çµ¦ä½¿ç”¨è€…æ‰‹å‹•è£œé»)
        async function generateSingleImage(id) {
            const item = currentLevelData.find(i => i.id === id);
            if (!item) return;
            
            const container = document.getElementById(`ai-container-${id}`);
            container.innerHTML = `<div class="loader"></div><div style="color:#6C3483;">AI ç¹ªåœ–ä¸­...</div>`;

            try {
                const promptData = await generateImagePrompt(item.idiom, item.meaning);
                if(promptData) {
                    const imgBase64 = await generateImage(promptData.englishPrompt);
                    if(imgBase64) {
                        aiImageCache[id] = { url: imgBase64, desc: promptData.chineseDescription };
                        renderLearningCard();
                    }
                }
            } catch(e) {
                container.innerHTML = `<div style="color:red;">ç”Ÿæˆå¤±æ•—</div>`;
            }
        }

        // å°èˆªåŠŸèƒ½
        function nextLearnCard() {
            if (currentCardIndex < currentLevelData.length - 1) {
                currentCardIndex++;
                renderLearningCard();
            }
        }
        function prevLearnCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                renderLearningCard();
            }
        }
        function backToMap() {
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('level-screen').style.display = 'block';
        }
        function finishLearning() {
            if(confirm("æº–å‚™å¥½æ¥å—æŒ‘æˆ°äº†å—ï¼Ÿ")) startQuiz();
        }

        // --- æ¸¬é©—åŠŸèƒ½ (æ²¿ç”¨) ---
        function startQuiz() {
            document.getElementById('learning-screen').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
            currentQuizIndex = 0;
            score = 0;
            renderQuestion();
        }

        function renderQuestion() {
            const data = currentLevelData[currentQuizIndex].quiz;
            document.getElementById('question-text').innerText = data.question;
            const optionsDiv = document.getElementById('options-list');
            optionsDiv.innerHTML = "";
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('quiz-next-btn').style.display = 'none';

            const progress = ((currentQuizIndex) / currentLevelData.length) * 100;
            document.getElementById('quiz-progress-bar').style.width = progress + "%";

            data.options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(btn, opt, data.answer);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct) {
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            const isCorrect = selected.includes(correct.substring(1,2)); 
            
            const currentItem = currentLevelData[currentQuizIndex];
            const cachedImg = aiImageCache[currentItem.id];
            let feedbackHtml = "";

            if(isCorrect || selected === correct) {
                btn.classList.add('correct');
                score += 100 / currentLevelData.length;
                confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 } });
                feedbackHtml = `âœ… <strong>æ­£è§£ï¼</strong> ${currentItem.meaning}`;
            } else {
                btn.classList.add('wrong');
                document.querySelectorAll('.option-btn').forEach(b => {
                    if(b.innerText.includes(correct.substring(1,2))) b.classList.add('correct');
                });
                feedbackHtml = `âŒ <strong>å¯æƒœï¼</strong> æ­£ç¢ºç­”æ¡ˆæ˜¯ ${correct}ã€‚<br>é‡‹ç¾©ï¼š${currentItem.meaning}`;
            }

            // å¦‚æœæœ‰ AI ç”Ÿæˆçš„åœ–ç‰‡ï¼Œåœ¨è§£ææ™‚ä¹Ÿé¡¯ç¤ºå‡ºä¾†å¢å¼·è¨˜æ†¶
            if (cachedImg) {
                feedbackHtml += `<br><div style="margin-top:10px; text-align:center;"><img src="${cachedImg.url}" style="max-height:150px; border-radius:5px;"></div>`;
            }

            document.getElementById('feedback-area').innerHTML = feedbackHtml;
            document.getElementById('feedback-area').style.display = 'block';
            document.getElementById('quiz-next-btn').style.display = 'block';
        }

        function nextQuestion() {
            currentQuizIndex++;
            if (currentQuizIndex < currentLevelData.length) {
                renderQuestion();
            } else {
                showResult();
            }
        }

        function showResult() {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
            document.getElementById('final-score').innerText = Math.round(score);
            let comment = score >= 80 ? "å¤ªå¼·äº†ï¼ç‹€å…ƒåŠç¬¬ï¼ğŸ‰" : "å†æ¥å†å²ï¼Œå›è—ç¶“é–£å¤šçœ‹å¹¾å¼µåœ–è§£å§ï¼ğŸ“š";
            document.getElementById('result-comment').innerText = comment;
        }
    </script>
</body>
</html>